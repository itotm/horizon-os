#!/bin/bash
set -oue pipefail

logger "HorizonOS checking version"

EXPECTED_FILE="/etc/horizon-version"
if [ -z "$1" ]; then
    echo "ERROR: ACTUAL_FILE path required as first argument" >&2
    exit 11
fi
ACTUAL_FILE="$1"

if [ ! -f "$EXPECTED_FILE" ]; then
    echo "ERROR: Version file not found: $EXPECTED_FILE" >&2
    exit 10
fi
EXPECTED=$(cat "$EXPECTED_FILE")

if [ ! -f "$ACTUAL_FILE" ]; then
    echo "HorizonOS installed with version: $EXPECTED"
    exit 1
fi

ACTUAL=$(cat "$ACTUAL_FILE")

if [ "$ACTUAL" = "$EXPECTED" ]; then
    echo "HorizonOS running current version: $EXPECTED"
    exit 0
else
    echo "HorizonOS updated from $ACTUAL to $EXPECTED"
    exit 2
fi
