#!/bin/bash
set -oue pipefail

logger "HorizonOS installing flatpaks"

if flatpak remotes | grep -q "^fedora"; then
    flatpak list --app --columns=application | while read -r app; do
        if [ -n "$app" ]; then
            flatpak uninstall -y "$app" 2>/dev/null || true
        fi
    done

    flatpak list --runtime --columns=application | while read -r runtime; do
        if [ -n "$runtime" ]; then
            flatpak mask --remove "$runtime" 2>/dev/null || true
        fi
    done

    flatpak list --runtime --columns=application | while read -r runtime; do
        if [ -n "$runtime" ]; then
            flatpak uninstall -y "$runtime" 2>/dev/null || true
        fi
    done

    for remote in fedora fedora-testing; do
        if flatpak remotes | grep -q "^$remote"; then
            flatpak remote-delete "$remote" 2>/dev/null || true
        fi
    done

    flatpak uninstall --unused -y 2>/dev/null || true
fi

flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo
flatpak remote-modify --enable flathub

FLATPAK_PACKAGES=(
    com.calibre_ebook.calibre
    com.github.PintaProject.Pinta
    com.github.tchx84.Flatseal
    com.ranfdev.DistroShelf
    com.usebottles.bottles
    fr.handbrake.ghb
    io.github.flattool.Warehouse
    io.github.slgobinath.SafeEyes
    io.github.zarestia_dev.rclone-manager
    net.cozic.joplin_desktop
    net.lutris.Lutris
    net.mediaarea.MediaInfo
    net.nokyan.Resources
    no.mifi.losslesscut
    org.audacityteam.Audacity
    org.avidemux.Avidemux
    org.bunkus.mkvtoolnix-gui
    org.deskflow.deskflow
    org.fkoehler.KTailctl
    org.gnome.meld
    org.gimp.GIMP
    org.inkscape.Inkscape
    org.kde.kalzium
    org.kde.kgeography
    org.kde.kmahjongg
    org.kde.kmines
    org.kde.kpat
    org.kde.marble
    org.libreoffice.LibreOffice
    org.qbittorrent.qBittorrent
    org.virt_manager.virt-manager
)

for package in "${FLATPAK_PACKAGES[@]}"; do
    if ! flatpak list --app --columns=application | grep -Fxq "$package"; then
        flatpak install -y "$package"
    fi
done

flatpak override --user --filesystem=xdg-config/gtk-3.0:ro
flatpak override --user --filesystem=xdg-config/gtk-4.0:ro

flatpak override --user --env=WEBKIT_DISABLE_COMPOSITING_MODE=1 io.github.zarestia_dev.rclone-manager
flatpak override --user io.github.zarestia_dev.rclone-manager --talk-name=org.freedesktop.Flatpak
flatpak override --user io.github.zarestia_dev.rclone-manager --filesystem=~/.config/autostart:create
