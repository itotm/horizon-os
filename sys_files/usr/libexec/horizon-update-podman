#!/bin/bash
set -euo pipefail

logger "System update: podman"

if ! command -v podman &> /dev/null; then
    logger "podman not found"
    exit 0
fi

images=$(podman images --format "{{.Repository}}:{{.Tag}}" | grep -v "<none>" || true)

if [ -z "$images" ]; then
    logger "no podman images"
    exit 0
fi

for image in $images; do
    logger "podman updating $image"
    if podman pull "$image" 2>&1 | tee /tmp/podman_pull.log | grep -q "Downloaded"; then
        logger "podman $image updated"
    else
        logger "podman $image already up to date or error"
    fi
done

podman image prune -f 2>&1 | logger

logger "podman images update completed"
exit 0